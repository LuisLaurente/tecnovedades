document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("min_price"),t=document.getElementById("max_price"),n=document.getElementById("categoria"),r=document.getElementById("orden"),a=document.getElementById("disponibles"),i=document.querySelectorAll(".etiqueta-checkbox"),o=document.getElementById("btnFiltrar"),s=document.getElementById("btnLimpiar"),l=document.getElementById("loading"),d=document.getElementById("productosContainer"),c=document.getElementById("errorFiltros"),p=document.getElementById("filtrosActivos"),u=document.getElementById("infoFiltros"),g=document.getElementById("listaErrores"),h=null;function E(e){l&&(l.style.display=e?"inline":"none"),o&&(o.disabled=e),s&&(s.disabled=e)}function m(e){c&&g&&(e&&e.length>0?(g.innerHTML="",e.forEach(e=>{let t=document.createElement("li");t.textContent=e,g.appendChild(t)}),c.style.display="block"):c.style.display="none")}function f(e,t){if(!p||!u)return;let a=!1,i="";if(e.min_price&&e.min_price>0&&(i+=`<span class="filtro-tag">
                M\xednimo: S/ ${parseFloat(e.min_price).toFixed(2)}
            </span>`,a=!0),e.max_price&&e.max_price>0&&(i+=`<span class="filtro-tag">
                M\xe1ximo: S/ ${parseFloat(e.max_price).toFixed(2)}
            </span>`,a=!0),e.categoria){let o=n.querySelector(`option[value="${e.categoria}"]`),s=o?o.textContent:"Categor\xeda seleccionada";i+=`<span class="filtro-tag">
                Categor\xeda: ${s}
            </span>`,a=!0}if(e.etiquetas&&e.etiquetas.length>0&&(i+=`<span class="filtro-tag">
                Etiquetas: ${e.etiquetas.length}
            </span>`,a=!0),e.disponibles&&(i+=`<span class="filtro-tag">
                Solo disponibles
            </span>`,a=!0),e.orden){let l=r.querySelector(`option[value="${e.orden}"]`),d=l?l.textContent:"Ordenamiento";i+=`<span class="filtro-tag">
                Orden: ${d}
            </span>`,a=!0}void 0!==t&&(i+=`<span class="filtro-tag total">
                ${t} producto(s) encontrado(s)
            </span>`),a?(u.innerHTML=i,p.style.display="block"):p.style.display="none"}function v(e){if(!d)return;if(!e||0===e.length){d.innerHTML="<p>No hay productos disponibles.</p>";return}let t="";e.forEach(e=>{t+=`
                <div class="producto-card">
                    <strong>${e.nombre||""}</strong><br>
                    ${e.descripcion||""}<br>
                    Precio: S/ ${parseFloat(e.precio||0).toFixed(2)}<br>
                    Visible: ${e.visible?"S\xed":"No"}<br>
                    
                    ${e.categorias&&e.categorias.length>0?`<div class="categoria-lista">Categor\xedas: ${e.categorias.join(", ")}</div>`:'<div class="categoria-lista">Sin categor\xeda</div>'}

                    <div class="acciones">
                        <a href="/producto/editar/${e.id}">Editar</a> |
                        <a href="/producto/eliminar/${e.id}" onclick="return confirm('\xbfEst\xe1s seguro de eliminar este producto?')">Eliminar</a>
                    </div>
                </div>
            `}),d.innerHTML=t}function y(){let o=e?e.value.trim():"",s=t?t.value.trim():"",l=n?n.value:"",d=r?r.value:"",c=!!a&&a.checked,p=function e(){let t=[];return i.forEach(e=>{e.checked&&t.push(e.value)}),t}();E(!0),m([]);let u=new URLSearchParams;o&&u.append("min_price",o),s&&u.append("max_price",s),l&&u.append("categoria",l),d&&u.append("orden",d),c&&u.append("disponibles","1"),p.forEach(e=>u.append("etiquetas[]",e)),u.append("ajax","1");let g=document.querySelector("body").getAttribute("data-base-url")+"producto",h=g+"?"+u.toString();fetch(h,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);let t=e.headers.get("content-type");return t&&t.includes("application/json")?e.json():e.text().then(e=>{throw console.error("Respuesta no JSON recibida:",e.substring(0,200)),Error("Respuesta no es JSON v\xe1lido")})}).then(e=>{E(!1),e.success?(v(e.productos),f(e.filtros,e.total),m([])):m(e.errores||["Error al filtrar productos"])}).catch(e=>{E(!1),console.error("Error completo:",e),m([`Error de conexi\xf3n: ${e.message}`])})}function b(){clearTimeout(h),h=setTimeout(y,800)}o&&o.addEventListener("click",y),s&&s.addEventListener("click",function o(){e&&(e.value=""),t&&(t.value=""),n&&(n.value=""),r&&(r.value=""),a&&(a.checked=!1),i.forEach(e=>{e.checked=!1}),E(!0),m([]),f({},0);let s=document.querySelector("body").getAttribute("data-base-url")+"producto";fetch(s+"?ajax=1",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);let t=e.headers.get("content-type");return t&&t.includes("application/json")?e.json():e.text().then(e=>{throw console.error("Respuesta no JSON recibida:",e.substring(0,200)),Error("Respuesta no es JSON v\xe1lido")})}).then(e=>{E(!1),e.success&&(v(e.productos),f({},e.total))}).catch(e=>{E(!1),console.error("Error:",e),m(["Error de conexi\xf3n. Intenta nuevamente."])})}),n&&n.addEventListener("change",y),r&&r.addEventListener("change",y),a&&a.addEventListener("change",y),i.forEach(e=>{e.addEventListener("change",y)}),e&&(e.addEventListener("input",b),e.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),clearTimeout(h),y())})),t&&(t.addEventListener("input",b),t.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),clearTimeout(h),y())})),window.addEventListener("load",function(){let e=new URLSearchParams(window.location.search);e.has("min_price")||e.has("max_price")||e.has("categoria")||e.has("orden")||f({},d.children.length)})});